services:
  # Nginx - Reverse proxy + SSL + serves frontend + proxies API
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/prod.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - frontend_build:/var/www/frontend:ro
      - certbot_webroot:/var/www/certbot:ro
      - certbot_certs:/etc/letsencrypt:ro
    depends_on:
      php:
        condition: service_started
      frontend-builder:
        condition: service_completed_successfully
    networks:
      - prorata

  # Frontend builder - builds static files and exits
  frontend-builder:
    build:
      context: ../frontend
      dockerfile: Dockerfile.prod
      args:
        VITE_API_URL: /api
    volumes:
      - frontend_build:/output
    networks:
      - prorata

  # Backend PHP-FPM
  php:
    build:
      context: ../backend
      dockerfile: Dockerfile.prod
    restart: unless-stopped
    depends_on:
      database:
        condition: service_healthy
    environment:
      APP_ENV: prod
      APP_SECRET: ${APP_SECRET}
      DATABASE_URL: mysql://prorata:${DB_PASSWORD}@database:3306/prorata?serverVersion=8.4&charset=utf8mb4
      JWT_SECRET_KEY: '%kernel.project_dir%/config/jwt/private.pem'
      JWT_PUBLIC_KEY: '%kernel.project_dir%/config/jwt/public.pem'
      JWT_PASSPHRASE: ${JWT_PASSPHRASE}
      CORS_ALLOW_ORIGIN: ${CORS_ALLOW_ORIGIN}
    volumes:
      - jwt_keys:/var/www/html/config/jwt
    networks:
      - prorata

  # MySQL Database
  database:
    image: mysql:8.4
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: prorata
      MYSQL_USER: prorata
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      timeout: 5s
      retries: 10
      start_period: 60s
    volumes:
      - database_data:/var/lib/mysql
    networks:
      - prorata

  # Certbot for SSL certificates renewal
  certbot:
    image: certbot/certbot
    restart: unless-stopped
    volumes:
      - certbot_webroot:/var/www/certbot
      - certbot_certs:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - prorata

volumes:
  database_data:
  jwt_keys:
  frontend_build:
  certbot_webroot:
  certbot_certs:

networks:
  prorata:
    driver: bridge